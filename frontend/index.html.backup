<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Tracking System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .fade-in {
            animation: fadeIn 0.4s ease-out;
        }

        .copy-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }

        .company-card {
            transition: all 0.3s ease;
        }

        .company-card:hover {
            transform: translateY(-4px);
        }

        .view-transition {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-gray-900">Lead Tracking System</h1>
                <button onclick="openAddModal()"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    + Add Lead
                </button>
            </div>
        </div>
    </header>

    <!-- Stats Bar -->
    <div class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <div id="stats" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Stats will be loaded here -->
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <!-- Search and Export -->
        <div class="mb-6 flex flex-col sm:flex-row gap-4">
            <div class="flex-1">
                <input type="text" id="searchInput" placeholder="Search by company, name, or email..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    onkeyup="handleSearch()">
            </div>
            <button onclick="exportToCSV()"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                Export to CSV
            </button>
        </div>

        <!-- Leads Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th onclick="sortBy('company_name')"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Company <span id="sort-company">↕</span>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Contact
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Title
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Email
                            </th>
                            <th onclick="sortBy('date_added')"
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                Date Added <span id="sort-date">↕</span>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status
                            </th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody id="leadsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Leads will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Add/Edit Modal -->
    <div id="leadModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-lg bg-white slide-in">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-900">Add New Lead</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="leadForm" onsubmit="handleSubmit(event)">
                <input type="hidden" id="leadId">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Name *</label>
                        <input type="text" id="companyName" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Name *</label>
                        <input type="text" id="contactName" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title *</label>
                        <input type="text" id="title" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email * (name@company.com)</label>
                        <input type="email" id="email" required pattern="[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">LinkedIn URL</label>
                        <input type="url" id="linkedinUrl"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                        <select id="status"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="not_contacted">Not Contacted</option>
                            <option value="contacted">Contacted</option>
                            <option value="responded">Responded</option>
                        </select>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                    <textarea id="notes" rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"></textarea>
                </div>

                <div id="warningMessage" class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                    <p class="text-sm text-yellow-800"></p>
                </div>

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                        Save Lead
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Copy Feedback Toast -->
    <div id="copyToast" class="hidden copy-feedback bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg slide-in">
        Email copied to clipboard!
    </div>

    <script>
        // Global state
        let allLeads = [];
        let currentSort = { field: null, ascending: true };
        let isEditing = false;

        // API base URL
        const API_BASE = '/api';

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            loadLeads();
            loadStats();
            setupKeyboardShortcuts();
        });

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+N or Cmd+N for new lead
                if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                    e.preventDefault();
                    openAddModal();
                }
            });
        }

        // Load all leads
        async function loadLeads(searchQuery = '') {
            try {
                const url = searchQuery ? `${API_BASE}/leads?search=${encodeURIComponent(searchQuery)}` : `${API_BASE}/leads`;
                const response = await fetch(url);

                if (!response.ok) throw new Error('Failed to load leads');

                allLeads = await response.json();
                renderLeads();
            } catch (error) {
                console.error('Error loading leads:', error);
                alert('Failed to load leads. Please try again.');
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                if (!response.ok) throw new Error('Failed to load stats');

                const stats = await response.json();
                renderStats(stats);
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Render statistics
        function renderStats(stats) {
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-500">Total Leads</div>
                    <div class="text-3xl font-bold text-gray-900 mt-2">${stats.total}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-500">Not Contacted</div>
                    <div class="text-3xl font-bold text-gray-600 mt-2">${stats.by_status.not_contacted}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-500">Contacted</div>
                    <div class="text-3xl font-bold text-blue-600 mt-2">${stats.by_status.contacted}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="text-sm font-medium text-gray-500">Responded</div>
                    <div class="text-3xl font-bold text-green-600 mt-2">${stats.by_status.responded}</div>
                </div>
            `;
        }

        // Render leads table
        function renderLeads() {
            const tbody = document.getElementById('leadsTableBody');

            if (allLeads.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            No leads found. Click "Add Lead" to get started!
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allLeads.map(lead => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="font-medium text-gray-900">${escapeHtml(lead.company_name)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${escapeHtml(lead.contact_name)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-600">${escapeHtml(lead.title)}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="copyToClipboard('${lead.email}')" class="text-sm text-blue-600 hover:text-blue-800 hover:underline">
                            ${escapeHtml(lead.email)}
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        ${formatDate(lead.date_added)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${getStatusBadge(lead.status)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick='editLead(${JSON.stringify(lead)})' class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deleteLead('${lead.id}', '${escapeHtml(lead.company_name)}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Get status badge HTML
        function getStatusBadge(status) {
            const badges = {
                'not_contacted': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Not Contacted</span>',
                'contacted': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">Contacted</span>',
                'responded': '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Responded</span>'
            };
            return badges[status] || badges['not_contacted'];
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Search handler with debouncing
        let searchTimeout;
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = document.getElementById('searchInput').value;
                loadLeads(query);
            }, 300);
        }

        // Sort leads
        function sortBy(field) {
            if (currentSort.field === field) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.field = field;
                currentSort.ascending = true;
            }

            allLeads.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                if (field === 'date_added') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }

                if (aVal < bVal) return currentSort.ascending ? -1 : 1;
                if (aVal > bVal) return currentSort.ascending ? 1 : -1;
                return 0;
            });

            // Update sort indicators
            document.getElementById('sort-company').textContent = currentSort.field === 'company_name' ? (currentSort.ascending ? '↑' : '↓') : '↕';
            document.getElementById('sort-date').textContent = currentSort.field === 'date_added' ? (currentSort.ascending ? '↑' : '↓') : '↕';

            renderLeads();
        }

        // Copy to clipboard
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showCopyToast();
            } catch (error) {
                console.error('Failed to copy:', error);
            }
        }

        // Show copy toast
        function showCopyToast() {
            const toast = document.getElementById('copyToast');
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 2000);
        }

        // Open add modal
        function openAddModal() {
            isEditing = false;
            document.getElementById('modalTitle').textContent = 'Add New Lead';
            document.getElementById('leadForm').reset();
            document.getElementById('leadId').value = '';
            document.getElementById('warningMessage').classList.add('hidden');
            document.getElementById('leadModal').classList.remove('hidden');
        }

        // Edit lead
        function editLead(lead) {
            isEditing = true;
            document.getElementById('modalTitle').textContent = 'Edit Lead';
            document.getElementById('leadId').value = lead.id;
            document.getElementById('companyName').value = lead.company_name;
            document.getElementById('contactName').value = lead.contact_name;
            document.getElementById('title').value = lead.title;
            document.getElementById('email').value = lead.email;
            document.getElementById('linkedinUrl').value = lead.linkedin_url || '';
            document.getElementById('status').value = lead.status;
            document.getElementById('notes').value = lead.notes || '';
            document.getElementById('warningMessage').classList.add('hidden');
            document.getElementById('leadModal').classList.remove('hidden');
        }

        // Close modal
        function closeModal() {
            document.getElementById('leadModal').classList.add('hidden');
            document.getElementById('leadForm').reset();
        }

        // Handle form submit
        async function handleSubmit(event) {
            event.preventDefault();

            const leadData = {
                company_name: document.getElementById('companyName').value,
                contact_name: document.getElementById('contactName').value,
                title: document.getElementById('title').value,
                email: document.getElementById('email').value,
                linkedin_url: document.getElementById('linkedinUrl').value || '',
                status: document.getElementById('status').value,
                notes: document.getElementById('notes').value || ''
            };

            try {
                const leadId = document.getElementById('leadId').value;
                const url = isEditing ? `${API_BASE}/leads/${leadId}` : `${API_BASE}/leads`;
                const method = isEditing ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(leadData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save lead');
                }

                const result = await response.json();

                // Show warning if duplicate email
                if (result.warning) {
                    const warningDiv = document.getElementById('warningMessage');
                    warningDiv.querySelector('p').textContent = result.warning;
                    warningDiv.classList.remove('hidden');

                    // Still close modal and reload after 2 seconds
                    setTimeout(() => {
                        closeModal();
                        loadLeads();
                        loadStats();
                    }, 2000);
                } else {
                    closeModal();
                    loadLeads();
                    loadStats();
                }

            } catch (error) {
                console.error('Error saving lead:', error);
                alert(error.message || 'Failed to save lead. Please check your input and try again.');
            }
        }

        // Delete lead
        async function deleteLead(leadId, companyName) {
            if (!confirm(`Are you sure you want to delete the lead for ${companyName}?`)) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/leads/${leadId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Failed to delete lead');

                loadLeads();
                loadStats();
            } catch (error) {
                console.error('Error deleting lead:', error);
                alert('Failed to delete lead. Please try again.');
            }
        }

        // Export to CSV
        async function exportToCSV() {
            try {
                const response = await fetch(`${API_BASE}/export`);
                if (!response.ok) throw new Error('Failed to export');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `leads_export_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } catch (error) {
                console.error('Error exporting:', error);
                alert('Failed to export leads. Please try again.');
            }
        }
    </script>
</body>

</html>
